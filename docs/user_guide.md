# 新功能使用指南

本指南說明如何使用 `auto_download_all.py` 的新功能：檔案過濾和增量下載。

## 功能概述

### 1. 檔案過濾功能
- **目的**: 允許用戶排除特定副檔名的檔案，避免下載不需要的檔案類型
- **適用場景**: 排除可執行檔案（.exe, .msi）、大型壓縮檔（.zip, .rar）等
- **優點**: 節省儲存空間、減少下載時間、提高安全性

### 2. 增量下載功能
- **目的**: 記錄下載進度，支援斷點續傳和增量同步
- **適用場景**: 定期同步新對話和檔案、網路中斷後恢復下載
- **優點**: 避免重複下載、提高效率、支援大型頻道的分批處理

## 配置設定

### 首次運行配置

當您首次運行 `auto_download_all.py` 時，程式會詢問以下新的配置選項：

```
是否要排除特定副檔名的檔案？ (y/n): y
請輸入要排除的副檔名（用逗號分隔，例如: .exe,.msi,.zip）: .exe,.msi,.zip
是否啟用增量下載功能？ (y/n): y
```

### 手動編輯配置檔案

您也可以直接編輯 `config.json` 檔案：

```json
{
  "host": "your-mattermost-server.com",
  "port": 443,
  "login_mode": "token",
  "download_files": true,
  "excluded_extensions": [".exe", ".msi", ".zip", ".rar"],
  "enable_incremental_download": true
}
```

## 檔案過濾功能詳解

### 支援的配置

- **excluded_extensions**: 要排除的副檔名列表
- **大小寫不敏感**: `.EXE` 和 `.exe` 效果相同
- **自動添加點號**: 輸入 `exe` 會自動轉換為 `.exe`

### 常見排除檔案類型

```json
"excluded_extensions": [
  ".exe",    // Windows 可執行檔
  ".msi",    // Windows 安裝包
  ".dmg",    // macOS 磁碟映像
  ".zip",    // 壓縮檔案
  ".rar",    // 壓縮檔案
  ".7z",     // 壓縮檔案
  ".iso",    // 光碟映像
  ".bin",    // 二進位檔案
  ".dll",    // 動態連結庫
  ".so"      // 共享物件檔案
]
```

### 檔案過濾統計

程式會顯示詳細的檔案處理統計：

```
=== 檔案下載統計 ===
總共下載檔案: 45 個
總共跳過檔案: 12 個

跳過檔案原因統計:
  - excluded_extension_.exe: 3 個
  - excluded_extension_.msi: 2 個
  - excluded_extension_.zip: 5 個
  - download_failed: 2 個
```

## 增量下載功能詳解

### 同步模式選擇

當程式檢測到之前的下載記錄時，會提供三種同步模式：

```
=== 發現同步歷史 ===
已同步的頻道數: 15
請選擇同步模式 (i=增量同步, f=完整重新同步, s=選擇性同步):
```

#### 1. 增量同步 (i)
- **適用**: 日常定期同步
- **行為**: 只下載新的對話和檔案
- **優點**: 速度快、節省頻寬

#### 2. 完整重新同步 (f)
- **適用**: 需要完整重新下載所有內容
- **行為**: 清空同步記錄，重新下載所有內容
- **優點**: 確保資料完整性

#### 3. 選擇性同步 (s)
- **適用**: 只想同步特定頻道
- **行為**: 手動選擇要同步的頻道
- **優點**: 靈活控制同步範圍

### 同步狀態管理

程式會在輸出目錄中創建 `download_progress.json` 檔案來記錄：

- 最後同步時間
- 各頻道的同步狀態
- 已下載檔案的記錄
- 同步配置資訊

### 斷點續傳

如果下載過程中發生中斷：

1. 重新運行程式
2. 選擇「增量同步」模式
3. 程式會自動跳過已下載的檔案
4. 繼續下載未完成的內容

## 使用範例

### 場景 1: 首次完整下載

```bash
python auto_download_all.py
```

1. 配置檔案過濾（排除 .exe, .msi, .zip）
2. 啟用增量下載功能
3. 選擇下載模式（通常選擇「全部下載」）
4. 開始完整下載

### 場景 2: 日常增量同步

```bash
python auto_download_all.py
```

1. 程式檢測到同步歷史
2. 選擇「增量同步 (i)」
3. 程式只下載新的對話和檔案
4. 更新同步狀態

### 場景 3: 網路中斷後恢復

```bash
python auto_download_all.py
```

1. 程式檢測到未完成的下載
2. 選擇「增量同步 (i)」
3. 程式跳過已下載的檔案
4. 繼續下載剩餘內容

## 進階設定

### 自訂排除規則

您可以根據需要調整排除規則：

```json
{
  "excluded_extensions": [
    ".exe", ".msi", ".dmg",  // 可執行檔案
    ".zip", ".rar", ".7z",   // 壓縮檔案
    ".iso", ".img",          // 映像檔案
    ".tmp", ".temp",         // 暫存檔案
    ".log"                   // 日誌檔案
  ]
}
```

### 效能調整

對於大型 Mattermost 伺服器，建議：

1. **啟用增量下載**: 減少重複處理
2. **合理設定排除規則**: 避免下載不必要的大檔案
3. **定期清理**: 刪除舊的下載記錄和檔案

### 故障排除

#### 問題 1: 同步狀態檔案損壞

**解決方案**: 刪除 `download_progress.json` 檔案，重新開始完整同步

```bash
rm results/*/download_progress.json
python auto_download_all.py
```

#### 問題 2: 檔案過濾不生效

**檢查項目**:
1. 確認 `config.json` 中的 `excluded_extensions` 格式正確
2. 確認副檔名包含點號（如 `.exe` 而非 `exe`）
3. 檢查大小寫是否正確

#### 問題 3: 增量下載遺漏新檔案

**解決方案**: 使用「完整重新同步」模式

```
請選擇同步模式 (i=增量同步, f=完整重新同步, s=選擇性同步): f
```

## 最佳實踐

### 1. 定期備份

- 定期備份 `config.json` 和 `download_progress.json`
- 備份重要的下載資料

### 2. 監控磁碟空間

- 定期檢查下載目錄的大小
- 適當調整檔案過濾規則

### 3. 日誌管理

- 定期檢查日誌檔案
- 清理舊的日誌檔案以節省空間

### 4. 網路環境

- 在穩定的網路環境下進行大量下載
- 利用增量同步功能應對網路中斷

## 技術支援

如果您在使用過程中遇到問題，請：

1. 檢查日誌檔案中的錯誤訊息
2. 確認配置檔案格式正確
3. 嘗試重新運行程式
4. 如有需要，可以刪除同步狀態檔案重新開始

---

**注意**: 這些新功能完全向後相容，現有的配置檔案和使用方式不會受到影響。